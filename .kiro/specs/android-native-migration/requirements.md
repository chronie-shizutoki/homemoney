# 需求文档

## 简介

本文档定义了将 Home Finance Tracker 安卓应用从 Capacitor 网页套壳逐步迁移到原生 Android 实现的需求。当前网页版本包含约 1.3 万行代码，实现了完整的财务管理功能。迁移将采用渐进式方法，逐个功能模块进行迁移，确保在迁移过程中应用始终保持可用状态。原生版本需要实现网页版的所有功能，包括支出追踪、债务管理、捐赠记录、会员管理和数据可视化等。

## 术语表

- **WebView应用**: 使用 Capacitor 框架将 Vue.js 网页应用打包成的安卓应用
- **原生应用**: 使用 Android SDK 和 Kotlin/Java 直接开发的安卓应用
- **混合架构**: 同时包含原生组件和 WebView 组件的应用架构
- **后端API**: 运行在 Node.js/Express 上的服务器端接口
- **本地数据库**: 安卓设备上的 SQLite 数据库
- **数据同步**: 在本地数据库和后端服务器之间同步数据的机制

## 需求

### 需求 1: 建立混合架构基础

**用户故事:** 作为开发者，我希望建立一个支持原生和 WebView 共存的混合架构，以便能够逐步迁移功能而不影响现有功能的使用。

#### 验收标准

1. THE 原生应用 SHALL 提供一个主导航框架，支持在原生界面和 WebView 界面之间切换
2. THE 原生应用 SHALL 保留现有的 Capacitor WebView 作为后备选项，用于尚未迁移的功能
3. THE 原生应用 SHALL 实现一个功能开关系统，允许在运行时选择使用原生实现或 WebView 实现
4. WHEN 用户首次启动应用时，THE 原生应用 SHALL 显示欢迎界面并请求必要的权限
5. THE 原生应用 SHALL 使用 Material Design 3 组件库确保一致的用户体验

### 需求 2: 实现本地数据存储

**用户故事:** 作为用户，我希望应用能够在本地存储我的财务数据，以便在离线状态下也能查看和添加记录。

#### 验收标准

1. THE 原生应用 SHALL 使用 Room 数据库框架在本地存储支出记录、债务记录和捐赠记录
2. THE 原生应用 SHALL 为每种数据类型定义对应的实体类和数据访问对象
3. THE 原生应用 SHALL 实现数据库迁移机制，支持未来的数据结构变更
4. WHEN 应用首次启动时，THE 原生应用 SHALL 创建必要的数据库表和索引
5. THE 原生应用 SHALL 加密敏感的财务数据，使用 Android Keystore 管理加密密钥

### 需求 3: 实现支出记录功能

**用户故事:** 作为用户，我希望能够使用原生界面添加、查看和编辑支出记录，以便获得更流畅的使用体验。

#### 验收标准

1. THE 原生应用 SHALL 提供一个原生界面用于添加新的支出记录，包括类型、金额、日期和备注字段
2. THE 原生应用 SHALL 显示支出记录列表，支持按日期降序排列
3. WHEN 用户点击某条支出记录时，THE 原生应用 SHALL 显示该记录的详细信息
4. THE 原生应用 SHALL 允许用户编辑或删除已有的支出记录
5. THE 原生应用 SHALL 在用户输入金额时提供数字键盘，并验证输入的有效性
6. THE 原生应用 SHALL 支持选择支出类型，包括餐饮、购物、交通、娱乐等预定义类别
7. THE 原生应用 SHALL 提供日期选择器，方便用户选择支出日期

### 需求 4: 实现数据同步机制

**用户故事:** 作为用户，我希望我的财务数据能够在本地和服务器之间自动同步，以便在多个设备上访问相同的数据。

#### 验收标准

1. THE 原生应用 SHALL 使用 Retrofit 库与后端 API 进行通信
2. WHEN 网络可用时，THE 原生应用 SHALL 自动将本地新增或修改的记录上传到服务器
3. WHEN 网络可用时，THE 原生应用 SHALL 自动从服务器下载新的记录到本地数据库
4. THE 原生应用 SHALL 处理同步冲突，优先使用最新修改时间的记录
5. WHEN 同步失败时，THE 原生应用 SHALL 将失败的操作加入队列，并在网络恢复后重试
6. THE 原生应用 SHALL 在后台执行数据同步，使用 WorkManager 调度同步任务
7. THE 原生应用 SHALL 在设置界面显示最后同步时间和同步状态

### 需求 5: 实现数据可视化

**用户故事:** 作为用户，我希望能够通过图表查看我的支出趋势和分类统计，以便更好地了解我的消费习惯。

#### 验收标准

1. THE 原生应用 SHALL 使用 MPAndroidChart 库显示支出趋势折线图
2. THE 原生应用 SHALL 显示按类别分组的支出饼图
3. THE 原生应用 SHALL 允许用户选择时间范围，包括本周、本月、本年和自定义范围
4. THE 原生应用 SHALL 计算并显示选定时间范围内的总支出金额
5. WHEN 用户点击图表中的某个数据点时，THE 原生应用 SHALL 显示该数据点的详细信息
6. THE 原生应用 SHALL 支持图表的缩放和滚动操作

### 需求 6: 实现多语言支持

**用户故事:** 作为用户，我希望应用能够根据我的系统语言自动切换界面语言，以便使用我熟悉的语言。

#### 验收标准

1. THE 原生应用 SHALL 支持简体中文、繁体中文和英文三种语言
2. THE 原生应用 SHALL 根据系统语言设置自动选择界面语言
3. THE 原生应用 SHALL 允许用户在设置中手动切换语言
4. WHEN 用户切换语言时，THE 原生应用 SHALL 立即更新所有界面文本，无需重启应用
5. THE 原生应用 SHALL 使用 Android 资源系统管理多语言字符串

### 需求 7: 实现数据导入导出

**用户故事:** 作为用户，我希望能够导出我的财务数据为 Excel 文件，并能够导入之前导出的数据，以便进行数据备份和迁移。

#### 验收标准

1. THE 原生应用 SHALL 允许用户将支出记录导出为 Excel 文件
2. THE 原生应用 SHALL 使用 Apache POI 库生成 Excel 文件
3. THE 原生应用 SHALL 将导出的文件保存到用户选择的位置
4. THE 原生应用 SHALL 允许用户从 Excel 文件导入支出记录
5. WHEN 导入数据时，THE 原生应用 SHALL 验证数据格式并显示导入结果摘要
6. THE 原生应用 SHALL 在导入前提示用户确认，避免意外覆盖现有数据

### 需求 8: 实现债务管理功能

**用户故事:** 作为用户，我希望能够记录和追踪我的债务信息，包括借入和借出的款项，以便管理我的债务关系。

#### 验收标准

1. THE 原生应用 SHALL 提供界面用于添加债务记录，包括债务人/债权人、金额、日期、状态和备注
2. THE 原生应用 SHALL 区分"借入"和"借出"两种债务类型
3. THE 原生应用 SHALL 显示债务列表，支持按状态筛选（未还清/已还清）
4. THE 原生应用 SHALL 允许用户标记债务为已还清状态
5. THE 原生应用 SHALL 计算并显示总借入金额和总借出金额

### 需求 9: 实现预算管理功能

**用户故事:** 作为用户，我希望能够设置月度预算限额，并在接近或超出预算时收到提醒，以便控制我的支出。

#### 验收标准

1. THE 原生应用 SHALL 允许用户设置月度总预算限额
2. THE 原生应用 SHALL 允许用户为不同支出类别设置独立的预算限额
3. THE 原生应用 SHALL 在主界面显示当前月份的预算使用情况，包括已用金额和剩余金额
4. WHEN 当月支出达到预算的 80% 时，THE 原生应用 SHALL 显示警告提示
5. WHEN 当月支出超过预算时，THE 原生应用 SHALL 显示超支提醒
6. THE 原生应用 SHALL 使用进度条可视化预算使用情况

### 需求 10: 实现用户认证

**用户故事:** 作为用户，我希望能够使用账号登录应用，以便在多个设备上同步我的数据。

#### 验收标准

1. THE 原生应用 SHALL 提供登录界面，支持用户名和密码登录
2. THE 原生应用 SHALL 使用 JWT 令牌进行身份验证
3. THE 原生应用 SHALL 安全地存储认证令牌，使用 Android Keystore
4. WHEN 令牌过期时，THE 原生应用 SHALL 自动刷新令牌或提示用户重新登录
5. THE 原生应用 SHALL 提供注销功能，清除本地存储的认证信息

### 需求 11: 实现搜索和筛选功能

**用户故事:** 作为用户，我希望能够快速搜索和筛选我的支出记录，以便找到特定的交易。

#### 验收标准

1. THE 原生应用 SHALL 提供搜索框，允许用户按备注内容搜索支出记录
2. THE 原生应用 SHALL 提供筛选选项，包括日期范围、支出类型和金额范围
3. THE 原生应用 SHALL 在用户输入搜索关键词时实时更新搜索结果
4. THE 原生应用 SHALL 显示搜索和筛选结果的数量
5. THE 原生应用 SHALL 允许用户清除所有筛选条件，恢复完整列表

### 需求 12: 实现离线模式

**用户故事:** 作为用户，我希望在没有网络连接时仍然能够使用应用的核心功能，以便随时记录我的支出。

#### 验收标准

1. THE 原生应用 SHALL 在离线状态下允许用户添加、查看和编辑支出记录
2. THE 原生应用 SHALL 在离线状态下显示本地缓存的数据
3. THE 原生应用 SHALL 在状态栏或界面上显示当前的网络连接状态
4. WHEN 网络恢复时，THE 原生应用 SHALL 自动同步离线期间的所有更改
5. THE 原生应用 SHALL 在离线模式下禁用需要网络连接的功能，并显示相应提示


### 需求 13: 实现捐赠记录功能

**用户故事:** 作为用户，我希望能够记录和追踪我的慈善捐赠，以便管理我的捐赠历史。

#### 验收标准

1. THE 原生应用 SHALL 提供界面用于添加捐赠记录，包括捐赠对象、金额、日期和备注
2. THE 原生应用 SHALL 显示捐赠记录列表，支持按日期排序
3. THE 原生应用 SHALL 允许用户编辑或删除捐赠记录
4. THE 原生应用 SHALL 计算并显示总捐赠金额和按时间段的捐赠统计
5. THE 原生应用 SHALL 支持导出捐赠记录为报表格式

### 需求 14: 实现会员管理功能

**用户故事:** 作为用户，我希望能够管理会员订阅信息，以便使用应用的高级功能。

#### 验收标准

1. THE 原生应用 SHALL 显示当前会员状态和到期时间
2. THE 原生应用 SHALL 提供会员订阅和续费功能
3. THE 原生应用 SHALL 显示会员特权和功能说明
4. THE 原生应用 SHALL 记录会员订阅历史
5. WHEN 会员即将到期时，THE 原生应用 SHALL 显示续费提醒

### 需求 15: 实现小程序管理功能

**用户故事:** 作为用户，我希望能够使用内置的小程序扩展应用功能，例如计算器等工具。

#### 验收标准

1. THE 原生应用 SHALL 提供小程序管理界面，显示可用的小程序列表
2. THE 原生应用 SHALL 支持启动和使用内置小程序
3. THE 原生应用 SHALL 支持从服务器动态加载小程序列表
4. THE 原生应用 SHALL 为小程序提供独立的运行环境
5. WHERE 小程序需要特殊权限时，THE 原生应用 SHALL 请求用户授权

### 需求 16: 实现渐进式迁移策略

**用户故事:** 作为开发者，我希望能够逐步迁移功能而不影响用户使用，以便降低迁移风险并保持应用稳定性。

#### 验收标准

1. THE 原生应用 SHALL 维护一个功能迁移状态配置，记录每个功能的迁移进度
2. THE 原生应用 SHALL 为每个功能提供"原生实现"和"WebView 实现"两种模式
3. THE 原生应用 SHALL 允许在设置中查看和切换功能实现模式（用于测试）
4. WHEN 某个功能尚未完成原生迁移时，THE 原生应用 SHALL 自动使用 WebView 实现
5. THE 原生应用 SHALL 在主界面提供迁移进度指示器，显示已迁移功能的百分比
6. THE 原生应用 SHALL 确保原生功能和 WebView 功能之间的数据一致性
