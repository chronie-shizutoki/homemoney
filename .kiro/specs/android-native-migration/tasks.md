# 实施计划

本文档定义了将 Home Finance Tracker 从 Capacitor WebView 迁移到原生 Android 应用的具体实施任务。每个任务完成后必须经过开发者测试和用户真机测试验证才能继续下一个任务。

## 第一阶段：基础设施

- [x] 1. 项目结构和依赖配置




  - 创建新的 Android 项目结构，使用 Kotlin 和 Jetpack Compose
  - 配置 build.gradle 文件，添加所有必需的依赖库（Hilt、Room、Retrofit、Compose 等）
  - 配置 Hilt 依赖注入框架
  - 创建多语言资源文件结构（values、values-zh-rCN、values-zh-rTW）
  - 从现有 Vue.js 应用的 i18n 文件中提取翻译，创建初始的 strings.xml 文件
  - 实现语言切换功能和语言偏好设置存储
  - 配置应用主题和 Material Design 3 样式
  - 生成 Debug APK 并验证应用可以正常启动和切换语言
  - _需求: 1.1, 16.1_


- [x] 2. 混合架构管理器


  - 创建 Feature 枚举类，定义所有功能模块（EXPENSES、DEBTS、DONATIONS 等）
  - 创建 ImplementationType 枚举类（NATIVE、WEBVIEW、HYBRID）
  - 实现 HybridArchitectureManager 接口和实现类
  - 实现功能迁移状态配置管理（使用 SharedPreferences 或本地配置文件）
  - 创建主导航框架，支持在原生界面和 WebView 之间切换
  - 保留现有的 Capacitor WebView 作为后备选项
  - 实现功能启动路由逻辑（根据迁移状态选择原生或 WebView）
  - 在设置界面添加功能实现模式切换选项（用于测试）
  - 在主界面添加迁移进度指示器
  - 生成 APK 并验证可以在原生界面和 WebView 之间正常切换
  - _需求: 1.1, 1.2, 1.3, 16.1, 16.2, 16.3, 16.4, 16.5_

- [x] 3. Room 数据库基础




  - 定义 ExpenseEntity、DebtEntity、MemberEntity 和 SyncQueueEntity 实体类
  - 为每个实体创建对应的 DAO 接口，定义基本的 CRUD 操作
  - 创建 AppDatabase 类，配置数据库版本和实体
  - 实现数据库迁移策略（Migration）
  - 为关键字段创建索引（time、type、is_synced 等）
  - 配置 SQLCipher 进行数据库加密
  - 使用 Hilt 提供数据库实例
  - 编写数据库基本操作的单元测试
  - 生成 APK 并验证数据库可以正常创建和执行增删改查操作
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 4. Retrofit API 客户端




  - 定义 API 接口（ExpenseApi、DebtApi、MemberApi 等）
  - 创建 API 响应数据模型（ExpenseDto、DebtDto 等）
  - 配置 Retrofit 实例，添加 Gson 转换器
  - 实现认证拦截器，自动添加 JWT 令牌到请求头
  - 实现日志拦截器，记录网络请求和响应
  - 实现错误处理拦截器，统一处理 HTTP 错误
  - 配置网络超时和重试策略
  - 使用 Hilt 提供 Retrofit 实例
  - 编写 API 调用的单元测试（使用 MockWebServer）
  - 生成 APK 并验证可以成功调用后端 API（测试获取支出列表接口）
  - _需求: 4.1, 4.2, 10.1, 10.2_

## 第二阶段：核心功能 - 支出管理

- [x] 5. 支出列表展示



  - 创建 Expense 领域模型和 ExpenseType 枚举
  - 实现 ExpenseRepository 接口和实现类
  - 实现数据映射器（Entity <-> Domain Model <-> DTO）
  - 创建 GetExpensesUseCase，实现分页加载逻辑
  - 创建 ExpenseListViewModel，管理列表状态和用户交互
  - 使用 Jetpack Compose 创建支出列表 UI
  - 实现 LazyColumn 展示支出记录
  - 实现下拉刷新功能
  - 实现上拉加载更多功能
  - 实现按日期分组显示
  - 为每种支出类型添加对应的图标
  - 实现列表项的点击事件（跳转到详情）
  - 所有 UI 文本使用 stringResource 引用多语言资源
  - 生成 APK 并验证支出列表可以正确显示和分页加载
  - _需求: 3.1, 3.2, 12.2_

- [x] 6. 添加支出记录


  - 创建 AddExpenseUseCase，实现数据验证和保存逻辑
  - 创建 AddExpenseViewModel，管理表单状态
  - 使用 Compose 创建添加支出界面
  - 实现支出类型选择器（Dropdown）
  - 实现金额输入框，配置数字键盘
  - 实现日期选择器（DatePicker）
  - 实现备注输入框
  - 实现表单验证（金额必须大于 0，类型必须选择等）
  - 实现保存按钮和取消按钮
  - 实现保存成功后的提示和页面返回
  - 实现保存失败的错误提示
  - 所有 UI 文本和错误提示使用多语言资源
  - 生成 APK 并验证可以成功添加支出记录
  - _需求: 3.1, 3.3, 3.5, 3.6, 3.7_

- [ ] 7. 编辑和删除支出
  - 创建 UpdateExpenseUseCase 和 DeleteExpenseUseCase
  - 创建 ExpenseDetailViewModel，管理详情和编辑状态
  - 创建支出详情界面，显示完整的支出信息
  - 实现编辑功能，复用添加支出的表单组件
  - 实现左滑删除手势
  - 实现删除确认对话框
  - 实现编辑成功/失败的提示
  - 实现删除成功/失败的提示
  - 更新列表界面，删除或编辑后自动刷新
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证可以成功编辑和删除支出记录
  - _需求: 3.4, 12.1_

- [x] 8. 搜索和筛选功能



  - 创建 ExpenseFilters 数据类，定义筛选条件
  - 在 ExpenseRepository 中实现筛选查询逻辑
  - 创建 SearchExpensesUseCase
  - 在 ExpenseListViewModel 中添加搜索和筛选状态管理
  - 在列表界面添加搜索框
  - 实现实时搜索（根据备注内容搜索）
  - 创建筛选界面或底部抽屉
  - 实现支出类型筛选（多选）
  - 实现日期范围筛选（开始日期和结束日期）
  - 实现金额范围筛选
  - 实现清除筛选条件功能
  - 显示当前筛选结果的数量
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证搜索和筛选功能正常工作
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_


- [x] 9. 数据同步机制



  - 创建 SyncManager 接口和实现类
  - 创建 SyncResult、UploadResult、DownloadResult 数据类
  - 实现上传本地更改到服务器的逻辑
  - 实现从服务器下载更新的逻辑
  - 实现同步冲突检测和解决策略（优先使用最新修改时间）
  - 实现同步队列管理（失败的操作加入队列）
  - 使用 WorkManager 实现后台同步任务
  - 实现网络状态监听，网络恢复时自动同步
  - 在设置界面显示最后同步时间和同步状态
  - 实现手动触发同步功能
  - 实现同步进度提示
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证数据可以正确同步（添加记录后检查服务器，从服务器添加记录后检查本地）
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 12.4, 16.6_

- [x] 10. 用户认证



  - 创建 Member 领域模型
  - 实现 MemberRepository 接口和实现类
  - 创建 LoginUseCase 和 LogoutUseCase
  - 使用 EncryptedSharedPreferences 存储 JWT 令牌？
  - 创建 AuthViewModel，管理认证状态
  - 创建登录界面（用户名输入）
  - 实现登录逻辑和错误处理
  - 实现自动登录（启动时检查令牌有效性）
  - 实现令牌过期处理和自动刷新？
  - 实现退出登录功能
  - 在设置界面显示当前登录用户
  - 未登录时限制全部功能的访问（即除了欢迎页其他都无法访问）
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证可以成功登录、保持登录状态和注销
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 11. 会员管理和订阅验证
  - 创建 SubscriptionStatus 和相关数据模型
  - 实现会员状态查询接口
  - 创建会员相关的 UseCases（GetMemberStatus、CheckSubscription）
  - 创建 MembershipViewModel
  - 在登录后立即检查会员状态
  - 实现会员状态拦截器（未订阅用户无法访问主要功能）
  - 创建会员管理界面
  - 显示当前会员状态和到期时间
  - 显示会员特权和功能说明
  - 实现会员订阅功能（调用后端 API）
  - 实现会员续费功能
  - 显示会员订阅历史
  - 实现会员即将到期提醒
  - 创建订阅引导界面（非会员用户首次登录时显示）
  - 根据会员状态控制功能访问权限
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证会员验证和订阅功能正常工作
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

## 第三阶段：扩展功能

- [ ] 12. 债务管理功能
  - 创建 Debt 领域模型和 DebtType 枚举
  - 实现 DebtRepository 接口和实现类
  - 创建债务相关的 UseCases（GetDebts、AddDebt、UpdateDebt、DeleteDebt、MarkAsRepaid）
  - 创建 DebtViewModel
  - 创建债务列表界面
  - 实现债务列表展示，区分借入和借出
  - 实现按状态筛选（未还清/已还清）
  - 创建添加债务界面
  - 实现债务类型选择（借入/借出）
  - 实现债务人/债权人输入
  - 实现金额、日期和备注输入
  - 实现编辑和删除债务功能
  - 实现标记为已还清功能
  - 显示总借入金额和总借出金额统计
  - 实现债务数据同步
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证债务管理功能正常工作
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 13. 捐赠记录功能
  - 创建 Donation 领域模型和相关实体
  - 实现 DonationRepository 接口和实现类
  - 创建捐赠相关的 UseCases
  - 创建 DonationViewModel
  - 创建捐赠列表界面
  - 实现捐赠记录展示
  - 创建添加捐赠界面
  - 实现捐赠对象、金额、日期和备注输入
  - 实现编辑和删除捐赠功能
  - 计算并显示总捐赠金额
  - 实现按时间段的捐赠统计
  - 实现捐赠数据同步
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证捐赠记录功能正常工作
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

- [x] 14. 预算管理功能



  - 创建 Budget 领域模型和相关实体
  - 实现 BudgetRepository 接口和实现类
  - 创建预算相关的 UseCases
  - 创建 BudgetViewModel
  - 创建预算设置界面
  - 实现月度总预算设置
  - 实现分类预算设置
  - 在主界面显示预算使用情况
  - 实现预算使用进度条
  - 实现预算警告提示（达到 80%）
  - 实现预算超支提醒
  - 实现预算数据同步
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证预算管理功能正常工作
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

## 第四阶段：数据可视化

- [x] 15. 支出统计和趋势图表



  - 创建 ExpenseStatistics 数据模型
  - 在 ExpenseRepository 中实现统计查询逻辑
  - 创建 GetStatisticsUseCase
  - 创建 ChartsViewModel
  - 创建图表界面
  - 实现时间范围选择器（本周、本月、本年、自定义）
  - 集成 MPAndroidChart 库
  - 实现支出趋势折线图
  - 实现图表数据加载和更新
  - 实现图表交互（点击显示详情、缩放、滚动）
  - 显示选定时间范围的总支出和平均值
  - 实现图表数据的多语言格式化（日期、货币）
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证趋势图表正确显示
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 16. 分类统计和饼图
  - 在统计查询中添加按类别分组的逻辑
  - 实现饼图展示支出分类占比
  - 实现分类列表展示，显示每个类别的金额和百分比
  - 实现饼图交互（点击显示该类别的详细记录）
  - 实现柱状图展示不同类别的对比
  - 实现环形图作为饼图的替代选项
  - 支持图表类型切换
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证分类统计正确显示
  - _需求: 5.1, 5.2, 5.5_

- [x] 17. 数据导入导出功能



  - 集成 Apache POI 库
  - 创建 ExportUseCase 和 ImportUseCase
  - 实现支出记录导出为 Excel 文件
  - 实现文件保存到用户选择的位置（使用 Storage Access Framework）
  - 实现从 Excel 文件导入支出记录
  - 实现导入数据验证和格式检查
  - 实现导入结果摘要显示
  - 实现导入前的确认对话框
  - 实现导出/导入进度提示
  - 处理文件读写权限请求
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证可以成功导出和导入数据
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

## 第五阶段：高级功能

- [ ] 18. 小程序管理功能
  - 创建 MiniApp 数据模型
  - 实现小程序列表查询接口
  - 创建小程序相关的 UseCases
  - 创建 MiniAppViewModel
  - 创建小程序管理界面
  - 显示可用的小程序列表
  - 实现小程序启动功能（使用 WebView 或原生实现）
  - 实现从服务器动态加载小程序列表
  - 为小程序提供独立的运行环境
  - 实现小程序权限管理和请求
  - 实现小程序与主应用的数据交互
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证小程序功能正常工作
  - _需求: 15.1, 15.2, 15.3, 15.4, 15.5_

## 第六阶段：优化和完善

- [ ] 19. 性能优化
  - 分析和优化数据库查询性能
  - 添加必要的数据库索引
  - 优化网络请求（批量操作、请求合并）
  - 实现图片和资源的懒加载
  - 优化 Compose UI 的重组性能
  - 使用 Baseline Profiles 优化启动速度
  - 实现内存泄漏检测和修复
  - 优化应用体积（移除未使用的资源和依赖）
  - 使用 ProGuard/R8 进行代码混淆和优化
  - 进行性能测试和基准测试
  - 生成 APK 并验证应用运行流畅，无明显卡顿
  - _需求: 所有功能的性能要求_

- [ ] 20. 离线模式完善
  - 完善离线状态检测和显示
  - 优化离线数据缓存策略
  - 实现离线操作队列管理
  - 实现网络恢复后的自动同步
  - 在离线模式下禁用需要网络的功能并显示提示
  - 实现离线模式下的数据一致性保证
  - 测试各种离线场景（添加、编辑、删除、同步）
  - 所有 UI 文本使用多语言资源
  - 生成 APK 并验证离线模式功能完整
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 21. 最终测试和发布准备
  - 进行全面的功能测试
  - 修复所有已知 Bug
  - 进行安全审计（检查数据加密、权限使用等）
  - 完善应用图标和启动画面
  - 准备应用商店截图和描述
  - 配置 Release 签名
  - 生成 Release APK
  - 进行最终的真机测试
  - 准备发布说明和更新日志
  - 完成应用商店提交准备
  - _需求: 所有需求的最终验证_
